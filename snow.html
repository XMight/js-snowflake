<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <TITLE>Snowflakes playground</TITLE>
</head>

<body>
  <div><button class="snowflakesToggle">Where is snow?</button></div>
  <div class="snowflakes" aria-hidden="true"></div>

  <script type='text/javascript'>
    //<![CDATA[
    let ctx = {};

    function componentToHex(c) {
      let hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
      return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function updateCurrentSimulationTime() {
      ctx.simulationTime = performance.now();
    }

    function updateElapsed() {
      let endTime = performance.now();
      ctx.elapsedMillis = endTime - ctx.startTime;
    }

    /**
     * @param {String} HTML representing a single element
     * @return {Element}
     **/
    function htmlToElement(html) {
      let template = document.createElement('template');
      html = html.trim(); // Never return a text node of whitespace as the result
      template.innerHTML = html;
      return template.content.firstChild;
    }

    function simulateChristmasTreeLights(snowflakes) {
      let currentMillis = performance.now();
      if (currentMillis - ctx.lightsSimulationStartMillis < 1000) {
        if (ctx.colorHasRun['1000'] === false) {
          for (let i = 0; i < snowflakes.length; i++) {
            let snowflake = snowflakes[i];
            if (i % 2 == 0) {
              snowflake.style['color'] = rgbToHex(255, 0, 0);
            } else {
              snowflake.style['color'] = rgbToHex(0, 255, 0);
            }
          }

          ctx.colorHasRun['1000'] = true;
        }
      } else if (currentMillis - ctx.lightsSimulationStartMillis < 2000) {
        if (ctx.colorHasRun['2000'] == false) {
          for (let i = 0; i < snowflakes.length; i++) {
            let snowflake = snowflakes[i];

            if (i % 2 == 0) {
              snowflake.style['color'] = rgbToHex(0, 255, 0);
            } else {
              snowflake.style['color'] = rgbToHex(255, 0, 0);
            }
          }

          ctx.colorHasRun['2000'] = true;
        }
      } else {
        ctx.lightsSimulationStartMillis = currentMillis;
        ctx.colorHasRun['1000'] = false;
        ctx.colorHasRun['2000'] = false;
      }
      //console.log('i: ' + i + '; currentLightsSimulationState: ' + currentLightsSimulationState
      //  + '; lightsSimulationElapsedTime: ' + lightsSimulationElapsedTime + '; snoflake: ' + snowflake.style['color']);
    }

    function changeSnowflakesPositions(snowflakes) {
      for (let i = 0; i < snowflakes.length; i++) {
        let snowflake = snowflakes[i];
        let top = snowflake.style['top'];
        if (top) {
          let topIntValue = parseFloat(top.split('px')[0], 10);
          if (topIntValue < window.innerHeight) {
            topIntValue += 2.5;
            let originalLeft = snowflake['originalLeft'];
            let cfv = snowflake['currentMotionFunctionValue'];
            if (cfv > 6.28) {
              cfv = 0;
            } else {
              cfv += 0.01;
            }

            let motionFunctionVal = Math.sin(cfv);
            let newLeft = originalLeft + 50 * motionFunctionVal;
            snowflake['currentMotionFunctionValue'] = cfv;
            snowflake.style['left'] = newLeft + 'px';
            //console.log('Cfv: ' + cfv + '; motionFunctionVal:' + motionFunctionVal + '; newLeft:' + newLeft);
          } else {
            topIntValue = -20;
            snowflake['currentMotionFunctionValue'] = 6.28 * Math.random();
          }
          top = topIntValue + 'px';
        } else {
          top = '0px';
        }

        snowflake.style['top'] = top;
      }
    }

    function runSnow() {
      updateElapsed();

      if (ctx.simulationTime - ctx.lastSimulationTime
        >= ctx.frameDeltaMillis) {
        let snowflakes = document.getElementsByClassName('snowflake');

        simulateChristmasTreeLights(snowflakes);
        changeSnowflakesPositions(snowflakes);

        ctx.lastSimulationTime = ctx.simulationTime;
      }

      updateCurrentSimulationTime();

      ctx.globalID = requestAnimationFrame(runSnow);
    }

    function getNextSnowflakeCode(i) {
      return '&#x' + (ctx.startSnowflakeCode + (i % 8)).toString(16) + ';';
    }

    function addNewSnowflake(container, snowflakeCode, leftPosition) {
      let sf = htmlToElement('<div class="snowflake">' + snowflakeCode + '</div>');
      sf.style['left'] = leftPosition + 'px';
      sf['originalLeft'] = leftPosition;
      sf['currentMotionFunctionValue'] = 6.28 * Math.random();
      sf.style['top'] = (Math.random() * -window.innerHeight) + 'px';
      container.appendChild(sf);
    }

    function initSnowflakesStyle() {
      let snowflakeStyle = document.createElement('style');
      snowflakeStyle.innerHTML = ':root{--snowflake-color:#000000;}.snowflake{color:var(--snowflake-color);text-shadow:0 0 5px#000;position:fixed;top:0%;z-index:9999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:normal;}';
      document.head.appendChild(snowflakeStyle);
    }

    function generateSnowflakes(snowflakesContainer) {
      let step = window.innerWidth / ctx.snowflakeCount;
      for (let i = 0; i < ctx.snowflakeCount; i++) {
        addNewSnowflake(snowflakesContainer, getNextSnowflakeCode(i), (1 + i * step));
      }
    }

    function resetSimulationState() {
      ctx.colorHasRun['1000'] = false;
      ctx.colorHasRun['2000'] = false;
    }

    function initSnowflakesParameters() {
      ctx.startSnowflakeCode = 10052;
      ctx.globalID = 0;
      ctx.startTime = 0;
      ctx.snowflakeCount = 25;
      ctx.elapsedMillis = 0;
      ctx.fps = 40;
      ctx.frameDeltaMillis = 1000 / ctx.fps;
      ctx.lastSimulationTime = 0;
      ctx.simulationTime = ctx.frameDeltaMillis;
      ctx.lightsSimulationStartMillis = 0;
      ctx.colorHasRun = {};
    }

    function initSnowflakes(snowflakesContainer) {
      initSnowflakesParameters();
      initSnowflakesStyle();
      generateSnowflakes(snowflakesContainer);
      resetSimulationState();
    }

    function runSnowflakesAnimation() {
      ctx.globalID = requestAnimationFrame(runSnow);
    }

    initSnowflakes(document.getElementsByClassName('snowflakes')[0]);

    runSnowflakesAnimation();
//]]>
  </script>
</BODY>

</HTML>