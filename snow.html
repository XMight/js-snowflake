<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <TITLE>Snowing animation inside a website</TITLE>
  <STYLE type="text/css">
    :root {
      --snowflake-color: #000000;
    }

    body {
      background-color: grey;
    }

    .snowflake {
      color: var(--snowflake-color);
      text-shadow: 0 0 10px #000;
      position: fixed;
      top: 0%;
      z-index: 9999;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      cursor: help;
    }
  </style>
</HEAD>

<BODY>
  <div class="snowflakes" aria-hidden="true">

  </div>
  <script type='text/javascript'>
    //<![CDATA[
    let startSnowflakeCode = 10052;
    var globalID;
    var startTime = 0;
    var snowflakeCount = 25;
    var elapsedMillis = 0;
    var fps = 40;
    var frameDeltaMillis = 1000 / fps;
    var lastSimulationTime = 0;
    var simulationTime = frameDeltaMillis;
    var lightsSimulationStartMillis = 0;
    var colorHasRun = {};

    var r = document.querySelector(':root');

    function componentToHex(c) {
      var hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
      return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function updateCurrentSimulationTime() {
      simulationTime = performance.now();
    }

    function updateElapsed() {
      let endTime = performance.now();
      let elapsedMillis = endTime - startTime;
    }

    /**
 * @param {String} HTML representing a single element
 * @return {Element}
 */
    function htmlToElement(html) {
      var template = document.createElement('template');
      html = html.trim(); // Never return a text node of whitespace as the result
      template.innerHTML = html;
      return template.content.firstChild;
    }

    function simulateChristmasTreeLights(snowflakes, frameDeltaMillis) {
      let currentMillis = performance.now();
      if (currentMillis - lightsSimulationStartMillis < 1000) {
        if (colorHasRun['1000'] === false) {
          for (let i = 0; i < snowflakes.length; i++) {
            let snowflake = snowflakes[i];
            if (i % 2 == 0) {
              snowflake.style['color'] = rgbToHex(255, 0, 0);
            } else {
              snowflake.style['color'] = rgbToHex(0, 255, 0);
            }
          }

          colorHasRun['1000'] = true;
        }
      } else if (currentMillis - lightsSimulationStartMillis < 2000) {
        if (colorHasRun['2000'] == false) {
          for (let i = 0; i < snowflakes.length; i++) {
            let snowflake = snowflakes[i];

            if (i % 2 == 0) {
              snowflake.style['color'] = rgbToHex(0, 255, 0);
            } else {
              snowflake.style['color'] = rgbToHex(255, 0, 0);
            }
          }

          colorHasRun['2000'] = true;
        }
      } else {
        lightsSimulationStartMillis = currentMillis;
        colorHasRun['1000'] = false;
        colorHasRun['2000'] = false;
      }
      //console.log('i: ' + i + '; currentLightsSimulationState: ' + currentLightsSimulationState
      //  + '; lightsSimulationElapsedTime: ' + lightsSimulationElapsedTime + '; snoflake: ' + snowflake.style['color']);
    }

    function changeSnowflakesPositions(snowflakes) {
      for (let i = 0; i < snowflakes.length; i++) {
        let snowflake = snowflakes[i];
        let top = snowflake.style['top'];
        if (top) {
          let topIntValue = parseFloat(top.split('px')[0], 10);
          if (topIntValue < window.innerHeight) {
            topIntValue += 2.5;
            let originalLeft = snowflake['originalLeft'];
            let cfv = snowflake['currentMotionFunctionValue'];
            if (cfv > 6.28) {
              cfv = 0;
            } else {
              cfv += 0.01;
            }

            let motionFunctionVal = Math.sin(cfv);
            let newLeft = originalLeft + 50 * motionFunctionVal;
            snowflake['currentMotionFunctionValue'] = cfv;
            snowflake.style['left'] = newLeft + 'px';
            //console.log('Cfv: ' + cfv + '; motionFunctionVal:' + motionFunctionVal + '; newLeft:' + newLeft);
          } else {
            topIntValue = -20;
            snowflake['currentMotionFunctionValue'] = 6.28 * Math.random();
          }
          top = topIntValue + 'px';
        } else {
          top = '0px';
        }

        snowflake.style['top'] = top;
      }
    }

    function runSnow() {
      updateElapsed();

      if (simulationTime - lastSimulationTime >= frameDeltaMillis) {
        let snowflakes = document.getElementsByClassName('snowflake');

        simulateChristmasTreeLights(snowflakes, frameDeltaMillis);
        changeSnowflakesPositions(snowflakes);

        lastSimulationTime = simulationTime;
      }

      updateCurrentSimulationTime();

      globalID = requestAnimationFrame(runSnow);
    }

    function getNextSnowflakeCode(i) {
      return '&#x' + (startSnowflakeCode + (i % 8)).toString(16) + ';';
    }

    function addNewSnowflake(container, snowflakeCode, leftPosition) {
      let sf = htmlToElement('<div class="snowflake">' + snowflakeCode + '</div>');
      sf.style['left'] = leftPosition + 'px';
      sf['originalLeft'] = leftPosition;
      sf['currentMotionFunctionValue'] = 6.28 * Math.random();
      sf.style['top'] = (Math.random() * -window.innerHeight) + 'px';
      container.appendChild(sf);
    }

    function createSnowflakes() {
      let snowflakesContainer = document.getElementsByClassName('snowflakes')[0];
      let step = window.innerWidth / snowflakeCount;
      for (let i = 0; i < snowflakeCount; i++) {
        addNewSnowflake(snowflakesContainer, getNextSnowflakeCode(i), (1 + i * step));
      }

      colorHasRun['1000'] = false;
      colorHasRun['2000'] = false;
    }

    createSnowflakes();

    globalID = requestAnimationFrame(runSnow);
//]]>
  </script>
</BODY>

</HTML>