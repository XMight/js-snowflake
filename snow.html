<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Snowflakes playground</title>
</head>

<body>
    <div><button class="snowflakesToggle">Where is snow?</button></div>
    <div class="snowflakes" aria-hidden="true"></div>
    <script type='text/javascript'>
        //<![CDATA[
        function SnowflakesEngine(snowflakesContainer, snowflakesCount, fps) {
            let _this = this;

            this.ctx = {};
            this.ctx.snowflakesCount = snowflakesCount;
            this.ctx.fps = fps;
            this.ctx.snowflakesContainer = snowflakesContainer;

            this.componentToHex = function (c) {
                let hex = c.toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            };

            this.rgbToHex = function (r, g, b) {
                return "#" + _this.componentToHex(r) + _this.componentToHex(g) + _this.componentToHex(b);
            }

            this.updateCurrentSimulationTime = function () {
                _this.ctx.simulationTime = performance.now();
            }

            this.updateElapsed = function () {
                let endTime = performance.now();
                _this.ctx.elapsedMillis = endTime - _this.ctx.startTime;
            }

            /**
            * @param {String} HTML representing a single element
            * @return {Element}
            **/
            this.htmlToElement = function (html) {
                let template = document.createElement('template');
                html = html.trim(); // Never return a text node of whitespace as the result
                template.innerHTML = html;
                return template.content.firstChild;
            }

            this.applyColorModulo2 = function (snowflakes, timeKey, color1, color2) {
                if (_this.ctx.colorHasRun[timeKey] == false) {
                    for (let i = 0; i < snowflakes.length; i++) {
                        snowflakes[i].style['color'] = i % 2 == 0 ? color1 : color2;
                    }

                    _this.ctx.colorHasRun[timeKey] = true;
                }
            }

            this.simulateChristmasTreeLights = function (snowflakes) {
                let currentMillis = performance.now();
                if (currentMillis - _this.ctx.lightsSimulationStartMillis < 1000) {
                    _this.applyColorModulo2(snowflakes, 1000, _this.ctx.colorRed, _this.ctx.colorGreen);
                } else if (currentMillis - _this.ctx.lightsSimulationStartMillis < 2000) {
                    _this.applyColorModulo2(snowflakes, 2000, _this.ctx.colorGreen, _this.ctx.colorRed);
                } else {
                    _this.ctx.lightsSimulationStartMillis = currentMillis;
                    _this.ctx.colorHasRun[1000] = false;
                    _this.ctx.colorHasRun[2000] = false;
                }
            }

            this.changeSnowflakesPositions = function (snowflakes) {
                for (let i = 0; i < snowflakes.length; i++) {
                    let snowflake = snowflakes[i];

                    let topIntValue = parseFloat(snowflake.style['top'].split('px')[0], 10);
                    if (topIntValue < window.innerHeight) {
                        topIntValue += _this.ctx.verticalPixelsStep;
                        let originalLeft = snowflake['originalLeft'];
                        let cfv = snowflake['currentMotionFunctionValue'];

                        cfv = cfv > _this.ctx.motionFunctionMaxValue ? 0 : cfv + _this.ctx.motionFunctionIncrement;
                        snowflake['currentMotionFunctionValue'] = cfv;

                        let motionFunctionVal = Math.sin(cfv);
                        let newLeft = originalLeft + 50 * motionFunctionVal;
                        snowflake.style['left'] = newLeft + 'px';
                    } else {
                        topIntValue = _this.ctx.topStartValue;
                        snowflake['currentMotionFunctionValue'] = _this.ctx.motionFunctionMaxValue * Math.random();
                    }

                    snowflake.style['top'] = topIntValue + 'px';
                }
            }

            this.runSnow = function () {
                _this.updateElapsed();

                if (_this.ctx.simulationTime - _this.ctx.lastSimulationTime >= _this.ctx.frameDeltaMillis) {
                    let snowflakes = document.getElementsByClassName('snowflake');

                    _this.simulateChristmasTreeLights(snowflakes);
                    _this.changeSnowflakesPositions(snowflakes);

                    _this.ctx.lastSimulationTime = _this.ctx.simulationTime;
                }

                _this.updateCurrentSimulationTime();

                _this.ctx.requestAnimationFrameId = requestAnimationFrame(_this.runSnow);
            }

            this.getNextSnowflakeCode = function (i) {
                return '&#x' + (_this.ctx.startSnowflakeCode + (i % 8)).toString(16) + ';';
            }

            this.addNewSnowflake = function (snowflakeCode, leftPosition) {
                let sf = _this.htmlToElement('<div class="snowflake">' + snowflakeCode + '</div>');
                sf.style['left'] = leftPosition + 'px';
                sf['originalLeft'] = leftPosition;
                sf['currentMotionFunctionValue'] = _this.ctx.motionFunctionMaxValue * Math.random();
                sf.style['top'] = (Math.random() * -window.innerHeight) + 'px';
                _this.ctx.snowflakesContainer.appendChild(sf);
            }

            this.initSnowflakesStyle = function () {
                let snowflakeStyle = document.createElement('style');
                snowflakeStyle.innerHTML = ':root{--snowflake-color:#000000;}.snowflake{color:var(--snowflake-color);text-shadow:0 0 5px#000;position:fixed;top:0%;z-index:9999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:normal;}';
                document.head.appendChild(snowflakeStyle);
            }

            this.generateSnowflakes = function () {
                let step = window.innerWidth / _this.ctx.snowflakesCount;
                for (let i = 0; i < _this.ctx.snowflakesCount; i++) {
                    _this.addNewSnowflake(_this.getNextSnowflakeCode(i), (1 + i * step));
                }
            }

            this.resetSimulationState = function () {
                _this.ctx.colorHasRun[1000] = false;
                _this.ctx.colorHasRun[2000] = false;
            }

            this.initSnowflakesParameters = function () {
                _this.ctx.startSnowflakeCode = 10052;
                _this.ctx.requestAnimationFrameId = 0;
                _this.ctx.startTime = 0;
                _this.ctx.elapsedMillis = 0;
                _this.ctx.frameDeltaMillis = 1000 / _this.ctx.fps;
                _this.ctx.lastSimulationTime = 0;
                _this.ctx.simulationTime = _this.ctx.frameDeltaMillis;
                _this.ctx.lightsSimulationStartMillis = 0;
                _this.ctx.colorHasRun = {};
                _this.ctx.colorGreen = _this.rgbToHex(0, 255, 0);
                _this.ctx.colorRed = _this.rgbToHex(255, 0, 0);
                _this.ctx.verticalPixelsStep = 2.5;
                _this.ctx.motionFunctionMaxValue = 6.28;
                _this.ctx.motionFunctionIncrement = 0.01;
                _this.ctx.topStartValue = -20;
            }

            this.initSnowflakes = function () {
                _this.initSnowflakesParameters();
                _this.initSnowflakesStyle();
                _this.generateSnowflakes();
                _this.resetSimulationState();
            }

            this.runSnowflakesAnimation = function () {
                _this.ctx.requestAnimationFrameId = requestAnimationFrame(_this.runSnow);
            }
        }

        const snowflakeEngine = new SnowflakesEngine(document.getElementsByClassName('snowflakes')[0], 25, 40);
        snowflakeEngine.initSnowflakes();
        snowflakeEngine.runSnowflakesAnimation();
//]]>
    </script>
</body>

</html>